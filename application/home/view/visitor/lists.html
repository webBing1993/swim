{extend name="public/common"}

{block name="style"}
<title>签到频道</title>
<link rel="stylesheet" href="/home/css/visitor/lists.css">
<link rel="stylesheet" href="/admin/css/plugins/toastr/toastr.min.css">
<style>
	#toast-container > div {
		opacity: 1;
	}
	.toast-message {
		font-size: 18px;
	}
	#toast-container.toast-bottom-center > div, #toast-container.toast-top-center > div {
		width: 50%;
	}
</style>
{/block}

{block name="body"}
<div class="lists">
	{volist name="res" id="vo"}
	<div class="list" data-tab="{$vo.userid}" data-tag="{$vo.class_id}">
		<div class="coach">
			<span class="name limit">教练：{$vo.name}/ {$vo.class_name}</span>
			<span class="num limit">学员情况：<span>{$vo.current_num}</span>/{$vo.all_num}</span>
		</div>
	</div>
	{/volist}
</div>
<input type="text"  class="number" maxlength="11" >
<!--<div class="sign">签到</div>-->
<div class="bg"></div>
<ul class="roster"></ul>
{/block}

{block name="script"}
<script src="/admin/js/plugins/toastr/toastr.min.js"></script>
<script>
    var a = '';
$(function(){
	var wh = $(window).height();
	$('body').height(wh);

	//签到
	var last = '';
	var end = true;
	//初始化签到
	$('.sign').on('click',function(){
		history.go(0)
	});
	$('.bg').off('click').on('click',function(){
		$('.bg,.roster').fadeOut();
		$('.number').focus();
	});
	$('.more').each(function(){
		var hh = $(this).parents('.content').height();
		$(this).height(hh).css('padding-top',hh - 18);
	})


    var clean;
    document.onkeyup = function (event) {
        var e = event || window.event;
        var keyCode = e.key;
        if (end == true && a.length < 11) {
            a += keyCode;
		} else {
            if(a.length == 11) {
                var re = /^[0-9]+.?[0-9]*$/; //判断字符串是否为数字 //判断正整数 /^[1-9]+[0-9]*]*$/
                var nubmer = a;

                if (!re.test(nubmer)) {
                    a = '';
                    end = false;
                    toastr.error('无效的二维码');
                    speckText('无效的二维码');
					if (clean) {
						clearTimeout(clean);
						clean = null;
					}
                    clean = setTimeout(function(){
                        end = true;
                    },1500);

                    return false;
                }

                var num = a;
                if(last!=num && end == true){
                    last = num;
                    end = false;
                    $.ajax({
                        type:"post",
                        url:"{:Url('Visitor/sign')}",
                        data:{
                            mobile: num
                        },
                        dataType: "Json",
                        success:function(data){
                            var obj = data.data;
                            var html = '';
                            var name = '';
                            if(obj){
                                if(obj[0].type == 1){
                                    for (var i=0;i<obj.length;i++) {

                                        html += '<div class="'+'list'+'" data-tab='+obj[i].coach_id+' data-tag='+obj[i].class_id+'>'+
                                            '<div class="'+'coach'+'">'+
                                            '<span class="'+'name limit'+'">教练：'+obj[i].name+'/'+obj[i].class_name+'</span>'+
                                            '<span class="'+'num limit'+'">学员情况：<span>0</span>/'+obj[i].num+'</span>'+
                                            '</div>'+
                                            '</div>';
                                    }

                                    name = obj[0].name;
                                    $('.lists').prepend(html);

                                }else{
                                    obj = obj[0];
                                    // class_id 为空是特殊学员
                                    if (obj.class_id!==0) {
                                        name = obj.name;

                                        //							html +=
                                        //								'<div class="student">'+
                                        //								'<span class="name limit">'+obj.name+'</span>'+
                                        //								'<span class="time limit">'+obj.time+'</span>'+
                                        //								'<span class="st limit">'+ obj.status_txt +'</span>'+
                                        //								'</div>';
                                        var list = $('.list[data-tab=' + obj.coach_id + '][data-tag=' + obj.class_id + ']');
                                        //							list.find('.students').prepend(html);
                                        list.find('.num span').text(obj.num);
                                        //							var len = list.find('.student').length;
                                        //							if(len == 3){
                                        //								list.find('.content').append('<div class="more limit"><span>更多...</span></div>')
                                        //							}else if(len == 4){
                                        //								list.find('.student').eq(3).remove();
                                        //							}
                                        var listclone = list.clone();
                                        list.remove();
                                        $('.lists').prepend(listclone);
                                    }

                                }
                            }


                            if(name){
                                speckText(name+data.msg);
                            }else{
                                speckText(data.msg);
                            }
                            if(data.code == 1){

                                setTimeout(function(){
                                    a = '';
                                    end = true;
                                    last ='';
                                },1500);
                                toastr.success(name+data.msg);
//                            alert('成功');
//                            swal({
//                                title: '成功',
//                                text: name+data.msg,
//                                type: 'success',
//                                showConfirmButton:false,
//                                timer:1000
//                            }).then(
//                                function () {},
//                                function (dismiss) {
//                                    if (dismiss === 'timer') {
//                                        a = '';
//                                        end = true;
//                                        last = '';
//                                    }
//                                }
//                            );
                            }else{
                                setTimeout(function(){
                                    a = '';
                                    end = true;
                                    last ='';
                                },1500);
                                toastr.error(data.msg);
//                            alert('失败');

//                            swal({
//                                title: '失败',
//                                text: data.msg,
//                                type: 'error',
//                                showConfirmButton:false,
//                                //							confirmButtonText:'确定',
//                                timer:1000
//                            }).then(
//                                function () {},
//                                function (dismiss) {
//                                    if (dismiss === 'timer') {
//                                        a = '';
//                                        end = true;
//                                        last = '';
//                                    }
//                                }
//                            );
                            }
                        }
                    })
                }else{
                    a = '';
                }

            }
		}

    }



});

// 播放声音
function speckText(str){
	var url = "http://tts.baidu.com/text2audio?lan=zh&ie=UTF-8&text=" + encodeURI(str);        // baidu
	var n = new Audio(url);
	n.src = url;
	n.play();
}

toastr.options = {
    "closeButton": true,
    "debug": false,
    "positionClass": "toast-top-center",
    "onclick": null,
    "showDuration": "500",
    "hideDuration": "500",
    "timeOut": "10000",
    "extendedTimeOut": "1000",
    "showEasing": "swing",
    "hideEasing": "linear",
    "showMethod": "fadeIn",
    "hideMethod": "fadeOut",
    "progressBar":true
}


</script>
{/block}